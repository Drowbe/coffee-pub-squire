{{#if (eq position "left")}}
    <div class="tray-title-small">
        <span>
            Quests
        </span>
        <div class="quest-toolbar">
            <i class="fas fa-sync-alt refresh-quest-button" title="Refresh Quests"></i>
            {{#if isGM}}
            <i class="fas fa-cog set-quest-button" title="Select Journal for Quests"></i>
            <i class="fas fa-file-import import-quests-json" title="Import Quests from JSON"></i>
            {{/if}}
        </div>
    </div>

    <div class="quest-filters">
        <div class="quest-search">
            <input type="text" placeholder="Search quests..." value="{{filters.search}}">
            <i class="fas fa-times clear-search {{#unless filters.search}}disabled{{/unless}}" title="Clear search"></i>
            <i class="fas fa-filter toggle-tags-button {{#unless isTagCloudCollapsed}}active{{/unless}}" title="Toggle tag filters"></i>
        </div>
        {{#if allTags.length}}
            <div class="quest-tag-cloud {{#if isTagCloudCollapsed}}collapsed{{/if}}">
                {{#each allTags}}
                    <span class="quest-tag {{#if (includes ../filters.tags this)}}selected{{/if}}" data-tag="{{this}}">{{this}}</span>
                {{/each}}
            </div>
        {{/if}}
    </div>

    <div class="quest-content">
        {{#each categories as |category|}}
            <div class="quest-section" data-category="{{category}}">
                {{#with (lookup @root.data category) as |entries|}}
                    <div class="quest-category">
                        
                            <h3>
                                <i class="fas {{#if (eq category "Main Quest")}}fa-flag{{else}}fa-map-signs{{/if}}"></i>
                                {{category}}{{#if entries.[1]}}s{{/if}}
                            </h3>
                        
                        <div class="quest-toolbar">
                            <i class="fas fa-chevron-down" title="Toggle {{category}}"></i>
                        </div>
                    </div>

                {{/with}}
                {{#if (lookup @root.hasJournal category)}}
                    {{#with (lookup @root.data category) as |entries|}}
                        <div class="quest-entries">
                            {{#each entries as |entry|}}
                                <div class="quest-entry collapsed">
                                    <div class="quest-entry-header">
                                        <div class="quest-entry-name">
                                            {{#if (eq entry.status "Complete")}}<i class="fas fa-badge-check"></i> {{/if}}
                                            {{#if (eq entry.status "Failed")}}<i class="fas fa-circle-xmark"></i> {{/if}}
                                            {{entry.name}}
                                        </div>
                                        <div class="quest-toolbar">
                                            <i class="fas fa-thumbtack quest-pin {{#if (eq entry.uuid (lookup @root.pinnedQuests category))}}pinned{{/if}}" data-uuid="{{entry.uuid}}" data-category="{{category}}" title="Pin this quest"></i>
                                            {{#if @root.isGM}}
                                                <i class="fas fa-ellipsis-h quest-status-menu" data-uuid="{{entry.uuid}}" title="Change Status"></i>
                                                <div class="quest-status-dropdown" style="display:none;">
                                                    <div class="quest-status-option" data-status="Not Started">Not Started</div>
                                                    <div class="quest-status-option" data-status="In Progress">In Progress</div>
                                                    <div class="quest-status-option" data-status="Complete">Complete</div>
                                                    <div class="quest-status-option" data-status="Failed">Failed</div>
                                                </div>
                                                <i class="fas fa-feather quest-entry-feather" data-uuid="{{entry.uuid}}" title="Open this journal page"></i>
                                                <i class="fas {{#if entry.visible}}fa-eye visible{{else}}fa-eye-slash invisible{{/if}} toggle-visible" data-uuid="{{entry.uuid}}" title="{{#if entry.visible}}Hide from players{{else}}Show to players{{/if}}"></i>
                                            {{/if}}
                                            <i class="fas fa-chevron-right quest-entry-toggle" title="Expand/Collapse"></i>
                                        </div>
                                    </div>
                                    {{#if entry.tasks.length}}
                                        <div class="quest-entry-progressbar">
                                            <div class="quest-entry-progressbar-fill" style="width: {{entry.progress}}%;"></div>
                                        </div>
                                    {{/if}}
                                    <div class="quest-entry-content">
                                        <div class="quest-entry-divider"></div>
                                        {{#if entry.img}}
                                        <div class="quest-entry-image">
                                            <img src="{{entry.img}}" alt="{{entry.name}}">
                                        </div>
                                        {{/if}}
                                        {{!-- DESCRIPTION --}} 
                                        {{#if entry.description}}
                                            <div class="quest-entry-description">
                                                <span class="quest-label">Description</span> 
                                                <p>{{entry.description}}</p>
                                            </div>
                                        {{/if}}
                                        {{!-- TASKS --}} 
                                        {{#if entry.tasks.length}}
                                            <div class="quest-entry-tasks">
                                                <span class="quest-label">Objectives {{#if entry.status}}({{entry.status}}){{/if}}</span> 
                                                <ul>
                                                    {{#each entry.tasks}}
                                                        {{#if @root.isGM}}
                                                            <li class="{{#if (eq this.state 'completed')}}task-complete{{/if}} {{#if (eq this.state 'hidden')}}task-hidden{{/if}}">
                                                                <i class="fas {{#if this.completed}}fa-check-square{{else}}fa-square{{/if}} task-checkbox" data-task-index="{{@index}}"></i>
                                                                {{this.text}}
                                                            </li>
                                                        {{else}}
                                                            {{#unless (eq this.state 'hidden')}}
                                                                <li class="{{#if (eq this.state 'completed')}}task-complete{{/if}}">
                                                                    <i class="fas {{#if this.completed}}fa-check-square{{else}}fa-square{{/if}}"></i>
                                                                    {{this.text}}
                                                                </li>
                                                            {{/unless}}
                                                        {{/if}}
                                                    {{/each}}
                                                </ul>
                                            </div>
                                        {{/if}}

                                        {{!-- PLOT HOOK --}} 
                                        {{#if @root.isGM}}
                                            {{#if entry.plotHook}}
                                                <div class="quest-entry-hook">
                                                    <span class="quest-label">Plot Hook</span> 
                                                    <p>{{entry.plotHook}}</p>
                                                </div>
                                            {{/if}}
                                        {{/if}}

                                        <div class="quest-entry-divider"></div>

                                        
                                        {{!-- TREASUREE --}} 

                                        {{#if entry.reward.treasure.length}}
                                            <div class="quest-entry-reward">
                                                <span class="quest-label">Treasure</span>
                                                <ul>
                                                    {{#each entry.reward.treasure}}
                                                        <li>
                                                            {{#if this.uuid}}
                                                                <a data-uuid="{{this.uuid}}">{{this.name}}</a>
                                                            {{else}}
                                                                {{this.text}}
                                                            {{/if}}
                                                        </li>
                                                    {{/each}}
                                                </ul>
                                            </div>
                                        {{/if}}


                                        <div class="quest-entry-divider"></div>

                                        {{#if entry.reward.xp}}
                                            <div class="quest-entry-reward">
                                                <span class="quest-label">Experience</span> {{entry.reward.xp}}
                                            </div>
                                        {{/if}}
                                        {{!-- LOCATION --}} 
                                        {{#if entry.location}}
                                            <div class="quest-entry-location">
                                                <span class="quest-label">Location</span> {{entry.location}}
                                            </div>
                                        {{/if}}

                                        {{!-- TIMEFRAME --}} 
                                        {{#if entry.timeframe.duration}}
                                            <div class="quest-entry-timeframe">
                                                <span class="quest-label">Timeframe</span> {{entry.timeframe.duration}}
                                            </div>
                                        {{/if}}

                                        {{!-- STATUS --}} 
                                        {{#if entry.status}}
                                            <div class="quest-entry-progress">
                                                <span class="quest-label">Status</span> {{entry.status}}
                                            </div>
                                        {{/if}}

                                        {{!-- PARTICIPANTS --}} 
                                        {{#if entry.participants.length}}
                                            <div class="quest-entry-participants">
                                                <div class="participant-portraits">
                                                    {{#each entry.participants}}
                                                        <div class="participant-portrait" data-uuid="{{this.uuid}}" title="{{this.name}}">
                                                            <img src="{{this.img}}" alt="{{this.name}}">
                                                        </div>
                                                    {{/each}}
                                                </div>
                                            </div>
                                        {{/if}}


                                        {{!-- TAGS --}} 
                                        {{#if entry.tags.length}}
                                            <div class="quest-entry-tags">
                                                {{#if entry.status}}
                                                    <span class="quest-tag quest-status {{#if (includes @root.filters.tags entry.status)}}selected{{/if}}" data-tag="{{entry.status}}">{{entry.status}}</span>
                                                {{/if}}
                                                {{#each entry.tags}}
                                                    <span class="quest-tag {{#if (includes @root.filters.tags this)}}selected{{/if}}" data-tag="{{this}}">{{this}}</span>
                                                {{/each}}
                                            </div>
                                        {{/if}}
                                    </div>
                                </div>
                            {{/each}}
                        </div>
                    {{/with}}
                {{else}}
                    <div class="no-quest-selected">
                        {{#if @root.isGM}}
                            <p>No journal has been selected for quests.</p>
                            <p>Click the <i class="fas fa-cog"></i> button to select a journal.</p>
                        {{else}}
                            <p>No quest journal has been selected by the GM yet.</p>
                        {{/if}}
                    </div>
                {{/if}}
            </div>
        {{/each}}
    </div>
{{/if}} 