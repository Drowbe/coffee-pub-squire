{{#if (eq position "left")}}
    <div class="tray-title-small">
        <span>{{journalName}}</span>
        <div class="notes-controls">
            {{#if isGM}}
            <i class="fa-solid fa-cog set-journal-button" title="Set Journal"></i>
            {{/if}}
            <i class="fa-solid fa-circle-plus new-note-button" title="New Note"></i>
            <i class="fa-solid fa-sync-alt refresh-notes-button" title="Refresh"></i>
        </div>
    </div>

    {{#if hasJournal}}
        <!-- Filters -->
        <div class="notes-filters">
            <!-- Search -->
            <div class="notes-search">
                <input type="text" class="notes-search-input" placeholder="Search notes..." value="{{filters.search}}">
                <i class="fa-solid fa-times clear-notes-search {{#unless filters.search}}disabled{{/unless}}" title="Clear search"></i>
                <i class="fa-solid fa-filter toggle-notes-filters-button {{#if filtersOpen}}active{{/if}}" title="Toggle filters"></i>
            </div>

            <div class="notes-filter-section {{#unless filtersOpen}}collapsed{{/unless}}">
                <!-- Tag Cloud -->
                {{#if allTags.length}}
                <div class="notes-tag-filter">
                    <div class="tag-cloud">
                        {{#each allTags}}
                        <span class="tag-item" data-tag="{{this}}">
                            {{toUpperCase this}}
                        </span>
                        {{/each}}
                    </div>
                </div>
                {{/if}}

                <!-- Scene Filter -->
                {{#if scenes.length}}
                <div class="notes-scene-filter">
                    <select class="scene-filter-select">
                        <option value="all" {{#if (eq filters.scene 'all')}}selected{{/if}}>All Scenes</option>
                        {{#each scenes}}
                        <option value="{{this}}" {{#if (eq ../filters.scene this)}}selected{{/if}}>{{this}}</option>
                        {{/each}}
                    </select>
                </div>
                {{/if}}

            </div>
        </div>

        <div class="notes-visibility-section">
            <div class="notes-visibility-buttons">
                <button class="notes-visibility-button {{#if (eq filters.visibility 'all')}}active{{/if}}" data-visibility="all" type="button" title="All Notes">
                    <i class="fa-solid fa-layer-group"></i>
                    <span>All</span>
                </button>
                <button class="notes-visibility-button {{#if (eq filters.visibility 'party')}}active{{/if}}" data-visibility="party" type="button" title="Party Notes">
                    <i class="fa-solid fa-users"></i>
                    <span>Party</span>
                </button>
                <button class="notes-visibility-button {{#if (eq filters.visibility 'private')}}active{{/if}}" data-visibility="private" type="button" title="Private Notes">
                    <i class="fa-solid fa-lock"></i>
                    <span>Private</span>
                </button>
            </div>
        </div>

        <!-- Notes Container -->
        <div class="notes-content">
            {{#if notes.length}}
                <div class="notes-list">
                    {{#each notes}}
                    <div class="note-card" data-note-uuid="{{uuid}}" data-scene="{{#if sceneName}}{{sceneName}}{{else}}none{{/if}}" data-visibility="{{visibility}}" data-tags="{{tagsCsv}}">
                        <!-- Note Header: badge | title | actions -->
                        <div class="note-header">
                            <span class="note-visibility-badge {{visibility}}">
                                {{#if (eq visibility 'party')}}
                                <i class="fa-solid fa-users"></i>
                                {{else}}
                                <i class="fa-solid fa-lock"></i>
                                {{/if}}
                            </span>
                            <div class="note-title">{{name}}</div>
                            <div class="note-actions">
                                <button class="note-edit" data-uuid="{{uuid}}" title="Edit Note">
                                    <i class="fa-solid fa-edit"></i>
                                </button>
                                {{#if sceneId}}
                                <button class="note-unpin" data-uuid="{{uuid}}" title="Unpin from Canvas">
                                    <i class="fa-solid fa-thumbtack"></i>
                                </button>
                                {{else}}
                                <button class="note-pin" data-uuid="{{uuid}}" title="Pin to Canvas">
                                    <i class="fa-solid fa-location-dot"></i>
                                </button>
                                {{/if}}
                                <button class="note-delete" data-uuid="{{uuid}}" title="Delete Note">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Note Content -->
                        <div class="note-content">
                            {{{content}}}
                        </div>

                        <!-- Note Location -->
                        {{#if sceneName}}
                        <div class="note-location">
                            <i class="fa-solid fa-map-pin"></i> {{sceneName}}
                        </div>
                        {{/if}}

                        <!-- Note Tags Section -->
                        {{#if tags}}
                        {{#if (isArray tags)}}
                        {{#if tags.length}}
                        <div class="note-tags-section">
                            <div class="note-tags-label">Tags:</div>
                            <div class="note-tags">
                                {{#each tags}}
                                <span class="note-tag">{{toUpperCase this}}</span>
                                {{/each}}
                            </div>
                        </div>
                        {{/if}}
                        {{else}}
                        <div class="note-tags-section">
                            <div class="note-tags-label">Tags:</div>
                            <div class="note-tags">
                                <span class="note-tag">{{tags}}</span>
                            </div>
                        </div>
                        {{/if}}
                        {{/if}}

                        <!-- Note Footer: author (left) | timestamp (right) -->
                        <div class="note-footer">
                            <span class="note-author">
                                {{#if editorAvatars.length}}
                                <span class="note-editor-avatars">
                                    {{#each editorAvatars}}
                                    <img class="note-editor-avatar" src="{{img}}" title="{{name}}" alt="{{name}}">
                                    {{/each}}
                                </span>
                                {{else}}
                                <i class="fa-solid fa-user"></i> {{#if authorName}}{{authorName}}{{else}}Unknown{{/if}}
                                {{/if}}
                            </span>
                            {{#if timestamp}}
                            <span class="note-date"><i class="fa-solid fa-clock"></i> {{formatTimestamp timestamp}}</span>
                            {{/if}}
                        </div>
                    </div>
                    {{/each}}
                </div>
            {{else}}
                <div class="no-notes">
                    <p>No notes found.</p>
                    <button class="new-note-button-large">
                        <i class="fa-solid fa-plus"></i> Create Your First Note
                    </button>
                </div>
            {{/if}}
        </div>
    {{else}}
        <div class="no-journal-selected">
            {{#if isGM}}
            <p>No journal has been selected for notes.</p>
            <p>Click the <i class="fa-solid fa-cog"></i> icon to select a journal.</p>
            <button class="set-journal-button-large">
                <i class="fa-solid fa-book"></i> Select Journal
            </button>
            {{else}}
            <p>No journal has been selected by the GM yet.</p>
            {{/if}}
        </div>
    {{/if}}
{{/if}}
