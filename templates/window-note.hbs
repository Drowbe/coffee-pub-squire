<form class="window-note {{#unless isEditMode}}window-note-view{{/unless}}" method="post">
    <div class="window-note-header">
        <div class="window-note-header-content">
            <div class="window-note-header-icon">
                {{#if note.iconHtml}}
                    {{{note.iconHtml}}}
                {{else}}
                    <i class="fa-solid fa-note-sticky"></i>
                {{/if}}
            </div>
            <div class="window-note-header-title">
                {{#if isEditMode}}
                    <input type="text" id="title" name="title" class="window-note-title-input" value="{{#if note.title}}{{note.title}}{{/if}}" placeholder="Note title" required>
                {{else}}
                    <div class="window-note-title-text">{{#if note.title}}{{note.title}}{{else}}Untitled Note{{/if}}</div>
                {{/if}}
                <div class="window-note-meta">
                    <span class="window-note-meta-item window-note-authors">
                        {{#if note.editorAvatars.length}}
                        <span class="note-editor-avatars">
                            {{#each note.editorAvatars}}
                            <img class="note-editor-avatar" src="{{img}}" title="{{name}}" alt="{{name}}">
                            {{/each}}
                        </span>
                        {{else}}
                        <i class="fa-solid fa-user"></i> {{#if note.authorName}}{{note.authorName}}{{else}}Unknown{{/if}}
                        {{/if}}
                    </span>
                    {{#if note.sceneName}}
                        <span class="window-note-meta-block">
                            <span class="window-note-meta-location">
                                <i class="fa-solid fa-location-dot window-note-meta-icon"></i>
                                {{note.sceneName}}
                            </span>
                            {{#if note.timestamp}}
                                <span class="window-note-meta-date"><i class="fa-solid fa-clock"></i> {{formatTimestamp note.timestamp}}</span>
                            {{else}}
                                <span class="window-note-meta-date"><i class="fa-solid fa-clock"></i> Not saved yet</span>
                            {{/if}}
                        </span>
                    {{else}}
                        {{#if note.timestamp}}
                            <span class="window-note-meta-item window-note-date"><i class="fa-solid fa-clock"></i> {{formatTimestamp note.timestamp}}</span>
                        {{else}}
                            <span class="window-note-meta-item window-note-date"><i class="fa-solid fa-clock"></i> Not saved yet</span>
                        {{/if}}
                    {{/if}}
                </div>
                {{#if editLock}}
                    <div class="window-note-editing-indicator" title="{{#if editLock.isSelf}}You are editing{{else}}{{editLock.userName}} is editing{{/if}}">
                        <i class="fa-solid fa-pen-to-square"></i>
                        <span>{{#if editLock.isSelf}}Editing{{else}}Editing: {{editLock.userName}}{{/if}}</span>
                    </div>
                {{/if}}
            </div>
            <div class="window-note-header-controls">
                {{#if isEditing}}
                <div class="notes-edit-toggle-container">
                    <span class="notes-edit-toggle-label">Edit</span>
                    <div class="notes-edit-toggle">
                        <input type="checkbox" id="notes-edit-toggle" {{#if isEditMode}}checked{{/if}} {{#unless canEdit}}disabled{{/unless}}>
                        <label for="notes-edit-toggle" class="notes-edit-toggle-slider"></label>
                    </div>
                </div>
                {{/if}}
                <div class="notes-visibility-toggle-container">
                    <span class="notes-visibility-toggle-label">Private</span>
                    <div class="notes-visibility-toggle">
                        <input type="checkbox" name="visibilityPrivate" id="notes-visibility-private" {{#if (eq note.visibility 'private')}}checked{{/if}} {{#unless isEditMode}}disabled{{/unless}}>
                        <label for="notes-visibility-private" class="notes-visibility-toggle-slider"></label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="window-note-body">
    <!-- Hidden fields -->
    <input type="hidden" name="sceneId" value="{{#if note.sceneId}}{{note.sceneId}}{{/if}}">
    <input type="hidden" name="x" value="{{#if note.x}}{{note.x}}{{/if}}">
    <input type="hidden" name="y" value="{{#if note.y}}{{note.y}}{{/if}}">

    <!-- Content -->
    <div class="notes-section notes-section-editor">
        <div class="notes-section-body">
            {{#if isEditMode}}
                {{#if page}}
                    {{editor page.text.content document=page target="text.content" fieldName="text.content" button=false editable=true engine="prosemirror" collaborate=true}}
                {{else}}
                    {{editor note.content target="content" button=false editable=true engine="prosemirror"}}
                {{/if}}
            {{else}}
                <div class="notes-view-content">{{{note.content}}}</div>
            {{/if}}
        </div>
    </div>

    <!-- Tags -->
    <div class="notes-section">
        <div class="notes-section-body">
            {{#if isEditMode}}
                <input type="text" id="tags" name="tags" class="notes-input" value="{{note.tagsText}}" placeholder="npc, phlan, informant">
                <div class="tag-suggestions">
                    {{#unless note.tagsText}}
                        <small>Enter tags separated by commas...</small>
                    {{/unless}}
                </div>
            {{else}}
                <div class="notes-view-tags">
                    {{#if note.tags.length}}
                        {{#each note.tags}}
                            <span class="notes-view-tag">{{this}}</span>
                        {{/each}}
                    {{else}}
                        <span class="notes-view-empty">No tags</span>
                    {{/if}}
                </div>
            {{/if}}
        </div>
    </div>

    </div>

    <!-- Action Buttons -->
    <div class="form-actions">
        <button type="button" class="btn-secondary cancel">
            <i class="fa-solid fa-times"></i> {{#if isEditMode}}Cancel{{else}}Close{{/if}}
        </button>
        {{#if isEditMode}}
        {{#unless note.sceneId}}
        <button type="submit" class="btn-secondary notes-save-place-pin" name="placePin" value="1" data-place-pin="true">
            <i class="fa-solid fa-map-pin"></i> Save and Place Pin
        </button>
        {{/unless}}
        <button type="submit" class="btn-primary">
            <i class="fa-solid fa-save"></i> Save Note
        </button>
        {{/if}}
    </div>
</form>
