<div class="spells-panel">
    {{#if (eq position "left")}}
    <div class="section-header">
        <div class="header-left">
            <i class="fas fa-magic"></i> Spells
        </div>
        <div class="header-right">
            <i class="fas fa-cog spell-filter-toggle filter-toggle {{#if showOnlyPrepared}}active{{else}}faded{{/if}}" title="Toggle Prepared Spells"></i>
        </div>
    </div>
    {{/if}}
    <div class="spell-controls">
        <input type="text" class="spell-search" placeholder="Search spells...">
        <select class="spell-filter">
            <option value="all">All</option>
            <option value="cantrip">C</option>
            {{#each spellSlots}}
            <option value="{{this.level}}">L{{this.level}}</option>
            {{/each}}
        </select>
    </div>

    {{#if (eq position "bottom")}}
    <div class="spell-slots">
        {{#each spellSlots}}
        <div class="slot-group">
            <div class="slot-label">Level {{this.level}}</div>
            <div class="slot-pips">
                {{#times this.max}}
                <div class="slot-pip {{#if (lt @index ../value)}}filled{{/if}}" 
                     data-level="{{../level}}"></div>
                {{/times}}
            </div>
        </div>
        {{/each}}
    </div>
    {{/if}}

    <div class="spells-list">
        {{#if (eq position "left")}}
            {{!-- Cantrips --}}
            <div class="level-header">Cantrips</div>
            {{#each spells as |spell|}}
                {{#if (eq spell.system.level 0)}}
                <div class="spell-item prepared" data-spell-id="{{spell.id}}">
                    <div class="spell-row">
                        <div class="spell-image-container">
                            <img class="spell-image" src="{{spell.img}}" alt="{{spell.name}}"/>
                            <i class="fas fa-dice-d20 spell-roll-overlay"></i>
                        </div>
                        <div class="spell-name">
                            {{spell.name}}
                        </div>
                        <div class="tray-buttons">
                            <i class="fas fa-cog" title="Always Prepared"></i>
                            <i class="fas fa-heart {{#unless spell.isFavorite}}faded{{/unless}}" title="Toggle Favorite"></i>
                            <i class="fas fa-feather"></i>
                        </div>
                    </div>
                </div>
                {{/if}}
            {{/each}}

            {{!-- Leveled Spells --}}
            {{#each spellSlots as |slot|}}
            {{#if (or (gt slot.max 0) (lookup ../spellsByLevel slot.level))}}
            <div class="level-header">
                <span>Level {{slot.level}}</span>
                <div class="slot-pips">
                    {{#times slot.max}}
                    <div class="slot-pip {{#if (lt @index ../value)}}filled{{/if}}" 
                         data-level="{{../level}}"></div>
                    {{/times}}
                </div>
            </div>
            {{#each (lookup ../spellsByLevel slot.level) as |spell|}}
                <div class="spell-item {{#if spell.system.preparation.prepared}}prepared{{/if}}" data-spell-id="{{spell.id}}">
                    <div class="spell-row">
                        <div class="spell-image-container">
                            <img class="spell-image" src="{{spell.img}}" alt="{{spell.name}}"/>
                            <i class="fas fa-dice-d20 spell-roll-overlay"></i>
                        </div>
                        <div class="spell-name">
                            {{spell.name}}
                        </div>
                        <div class="tray-buttons">
                            <i class="fas fa-cog {{#unless spell.system.preparation.prepared}}faded{{/unless}}" title="Prepared"></i>
                            <i class="fas fa-heart {{#unless spell.isFavorite}}faded{{/unless}}" title="Toggle Favorite"></i>
                            <i class="fas fa-feather"></i>
                        </div>
                    </div>
                </div>
            {{/each}}
            {{/if}}
            {{/each}}
        {{else}}
            {{!-- Bottom position: original flat list --}}
            {{#each spells}}
            <div class="spell-item {{#if this.prepared}}prepared{{/if}}" data-spell-id="{{this.id}}">
                <div class="spell-row">
                    <div class="spell-image-container">
                        <img class="spell-image" src="{{this.img}}" alt="{{this.name}}"/>
                        <i class="fas fa-dice-d20 spell-roll-overlay"></i>
                    </div>
                    <div class="spell-name">{{this.name}}</div>
                    <div class="spell-level">
                        {{#if (eq this.level 0)}}
                        C
                        {{else}}
                        {{this.level}}
                        {{/if}}
                    </div>
                    <div class="tray-buttons">
                        <i class="fas fa-cog {{#unless this.prepared}}faded{{/unless}}" title="Prepared"></i>
                        <i class="fas fa-heart {{#unless this.isFavorite}}faded{{/unless}}" title="Toggle Favorite"></i>
                        <i class="fas fa-feather"></i>
                    </div>
                </div>
            </div>
            {{/each}}
        {{/if}}
    </div>
</div> 